<?xml version="1.0" encoding="UTF-8"?>
<Calculation:scenario
    xmlns:Calculation="http://www.sap.com/ndb/BiModelCalculation.ecore"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    id="com.acme.sales::SIMPLE_SALES_BILLING_VKORG_PARAM"
    description="Sales-Billing example with VKORG parameter, customer join, and item-level measures"
    outputViewType="CUBE"
    dataCategory="CUBE"
    defaultLanguage="EN">

  <!-- ===========
       PARAMETERS
       =========== -->
  <parameters>
    <!-- VKORG filter parameter (string up to 4 chars). Change defaultValue to your org code if needed. -->
    <parameter id="P_VKORG" type="COLUMN" sqlType="NVARCHAR" length="4" defaultValue="1000" isMandatory="false"/>
  </parameters>

  <!-- ===========
       DATA SOURCES
       =========== -->
  <dataSources>
    <DataSource id="DS_VBRK" type="DATA_BASE_TABLE">
      <resourceUri>ACME_S4H::VBRK</resourceUri>
    </DataSource>
    <DataSource id="DS_VBRP" type="DATA_BASE_TABLE">
      <resourceUri>ACME_S4H::VBRP</resourceUri>
    </DataSource>
    <DataSource id="DS_KNA1" type="DATA_BASE_TABLE">
      <resourceUri>ACME_S4H::KNA1</resourceUri>
    </DataSource>
  </dataSources>

  <!-- ==========================
       CALCULATION VIEW NODES
       ========================== -->
  <calculationViews>

    <!-- Billing Header (VBRK) with VKORG parameterized filter -->
    <calculationView xsi:type="Calculation:ProjectionView" id="PRJ_VBRK">
      <viewAttributes>
        <viewAttribute id="VBELN_BI"/>   <!-- Billing document -->
        <viewAttribute id="VKORG"/>      <!-- Sales Organization -->
        <viewAttribute id="KUNAG"/>      <!-- Sold-to -->
        <viewAttribute id="FKDAT"/>      <!-- Billing date -->
        <viewAttribute id="WAERK"/>      <!-- Currency -->
        <viewAttribute id="NETWR_BI"/>   <!-- Header net value -->
      </viewAttributes>
      <filters>
        <!-- Parameterized filter -->
        <filter>VKORG = $$P_VKORG$$</filter>
      </filters>
      <input node="#DS_VBRK">
        <mapping xsi:type="Calculation:AttributeMapping" source="VBELN" target="VBELN_BI"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="VKORG" target="VKORG"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="KUNAG" target="KUNAG"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="FKDAT" target="FKDAT"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="WAERK" target="WAERK"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="NETWR" target="NETWR_BI"/>
      </input>
    </calculationView>

    <!-- Billing Item (VBRP) -->
    <calculationView xsi:type="Calculation:ProjectionView" id="PRJ_VBRP">
      <viewAttributes>
        <viewAttribute id="VBELN_BI"/>
        <viewAttribute id="POSNR_BI"/>
        <viewAttribute id="MATNR"/>
        <viewAttribute id="FKIMG"/>
        <viewAttribute id="NETWR_ITEM"/>
      </viewAttributes>
      <input node="#DS_VBRP">
        <mapping xsi:type="Calculation:AttributeMapping" source="VBELN" target="VBELN_BI"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="POSNR" target="POSNR_BI"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="MATNR" target="MATNR"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="FKIMG" target="FKIMG"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="NETWR" target="NETWR_ITEM"/>
      </input>
    </calculationView>

    <!-- Customer Master (KNA1) -->
    <calculationView xsi:type="Calculation:ProjectionView" id="PRJ_KNA1">
      <viewAttributes>
        <viewAttribute id="KUNNR"/>
        <viewAttribute id="NAME1"/>
        <viewAttribute id="LAND1"/>
      </viewAttributes>
      <input node="#DS_KNA1">
        <mapping xsi:type="Calculation:AttributeMapping" source="KUNNR" target="KUNNR"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="NAME1" target="NAME1"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="LAND1" target="LAND1"/>
      </input>
    </calculationView>

    <!-- Join: Header + Item -->
    <calculationView xsi:type="Calculation:JoinView" id="JOIN_HDR_ITEM">
      <joinType>Inner</joinType>
      <attributes>
        <attribute id="VBELN_BI"/>
        <attribute id="POSNR_BI"/>
        <attribute id="VKORG"/>
        <attribute id="KUNAG"/>
        <attribute id="FKDAT"/>
        <attribute id="WAERK"/>
        <attribute id="MATNR"/>
        <attribute id="FKIMG"/>
        <attribute id="NETWR_ITEM"/>
        <attribute id="NETWR_BI"/>
      </attributes>
      <input left="#PRJ_VBRK" right="#PRJ_VBRP">
        <joinCondition>
          <expression>PRJ_VBRK.VBELN_BI = PRJ_VBRP.VBELN_BI</expression>
        </joinCondition>
      </input>
    </calculationView>

    <!-- Join: Add Customer -->
    <calculationView xsi:type="Calculation:JoinView" id="JOIN_WITH_CUSTOMER">
      <joinType>LeftOuter</joinType>
      <attributes>
        <attribute id="VBELN_BI"/>
        <attribute id="POSNR_BI"/>
        <attribute id="VKORG"/>
        <attribute id="KUNAG"/>
        <attribute id="NAME1"/>
        <attribute id="LAND1"/>
        <attribute id="FKDAT"/>
        <attribute id="WAERK"/>
        <attribute id="MATNR"/>
        <attribute id="FKIMG"/>
        <attribute id="NETWR_ITEM"/>
        <attribute id="NETWR_BI"/>
      </attributes>
      <input left="#JOIN_HDR_ITEM" right="#PRJ_KNA1">
        <joinCondition>
          <expression>JOIN_HDR_ITEM.KUNAG = PRJ_KNA1.KUNNR</expression>
        </joinCondition>
      </input>
    </calculationView>

    <!-- Final Aggregation with VKORG and item-level measures -->
    <calculationView xsi:type="Calculation:AggregationView" id="AGG_FINAL">
      <viewAttributes>
        <viewAttribute id="VKORG"/>
        <viewAttribute id="KUNAG"/>
        <viewAttribute id="NAME1"/>
        <viewAttribute id="LAND1"/>
        <viewAttribute id="FKDAT"/>
        <viewAttribute id="WAERK"/>
        <viewAttribute id="MATNR"/>
      </viewAttributes>
      <measures>
        <measure id="BI_ITEM_VALUE" aggregationType="SUM" measureType="Simple">NETWR_ITEM</measure>
        <measure id="BI_HDR_VALUE"  aggregationType="SUM" measureType="Simple">NETWR_BI</measure>
        <measure id="BI_BILL_QTY"   aggregationType="SUM" measureType="Simple">FKIMG</measure>
      </measures>
      <input node="#JOIN_WITH_CUSTOMER">
        <mapping xsi:type="Calculation:AttributeMapping" source="VKORG"      target="VKORG"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="KUNAG"      target="KUNAG"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="NAME1"      target="NAME1"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="LAND1"      target="LAND1"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="FKDAT"      target="FKDAT"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="WAERK"      target="WAERK"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="MATNR"      target="MATNR"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="NETWR_ITEM" target="BI_ITEM_VALUE"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="NETWR_BI"   target="BI_HDR_VALUE"/>
        <mapping xsi:type="Calculation:AttributeMapping" source="FKIMG"      target="BI_BILL_QTY"/>
      </input>
    </calculationView>

  </calculationViews>

  <!-- =================
       LOGICAL (OUTPUT)
       ================= -->
  <logicalModel id="AGG_FINAL">
    <attributes>
      <attribute id="VKORG"/>
      <attribute id="KUNAG"/>
      <attribute id="NAME1"/>
      <attribute id="LAND1"/>
      <attribute id="FKDAT"/>
      <attribute id="WAERK"/>
      <attribute id="MATNR"/>
    </attributes>
    <measures>
      <measure id="BI_ITEM_VALUE"/>
      <measure id="BI_HDR_VALUE"/>
      <measure id="BI_BILL_QTY"/>
    </measures>
  </logicalModel>

</Calculation:scenario>